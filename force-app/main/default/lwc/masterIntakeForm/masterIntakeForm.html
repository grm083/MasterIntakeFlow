<template>
    <!-- Modal Header -->
    <div class="slds-modal__header">
        <h1 class="slds-modal__title slds-hyphenate">Master Intake Flow</h1>
        <template if:true={state.caseContext}>
            <p class="slds-text-body_small slds-text-color_weak">
                {caseContextDisplay}
            </p>
        </template>
        <template if:true={showQuestions}>
            <p class="slds-text-body_small slds-m-top_xx-small">
                <lightning-icon
                    icon-name="utility:checkin"
                    size="xx-small"
                    class="slds-m-right_xx-small">
                </lightning-icon>
                {questionCountDisplay}
            </p>
        </template>
        <!-- Minimize Button -->
        <template if:true={showQuestions}>
            <lightning-button-icon
                icon-name="utility:minimize_window"
                variant="bare"
                alternative-text="Minimize"
                title="Minimize - Continue later"
                onclick={handleMinimize}
                class="slds-modal__close minimize-button">
            </lightning-button-icon>
        </template>
    </div>

    <!-- Case Info Panel -->
    <template if:true={showCaseInfoPanel}>
        <div class="case-info-panel slds-p-horizontal_medium slds-p-vertical_small slds-border_bottom">
            <div class="slds-grid slds-gutters_x-small slds-wrap">
                <!-- Client -->
                <template if:true={hasClientName}>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                        <div class="info-badge">
                            <lightning-icon icon-name="standard:account" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                            <span class="slds-truncate" title={clientNameDisplay}>{clientNameDisplay}</span>
                        </div>
                    </div>
                </template>

                <!-- Location -->
                <template if:true={hasLocationName}>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                        <div class="info-badge">
                            <lightning-icon icon-name="standard:location" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                            <span class="slds-truncate" title={locationNameDisplay}>{locationNameDisplay}</span>
                        </div>
                    </div>
                </template>

                <!-- Asset -->
                <template if:true={hasAssetName}>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                        <div class="info-badge">
                            <lightning-icon icon-name="standard:asset_object" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                            <span class="slds-truncate" title={assetNameDisplay}>{assetNameDisplay}</span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Second Row -->
            <template if:true={hasSecondaryInfo}>
                <div class="slds-grid slds-gutters_x-small slds-wrap slds-m-top_x-small">
                    <!-- Contact -->
                    <template if:true={hasContactName}>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                            <div class="info-badge-secondary">
                                <lightning-icon icon-name="standard:contact" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                <span class="slds-truncate" title={contactNameDisplay}>{contactNameDisplay}</span>
                            </div>
                        </div>
                    </template>

                    <!-- Service Date -->
                    <template if:true={hasServiceDate}>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                            <div class="info-badge-secondary">
                                <lightning-icon icon-name="standard:event" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                <span class="slds-truncate" title={serviceDateDisplay}>{serviceDateDisplay}</span>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </template>

    <!-- Modal Content -->
    <div class="slds-modal__content intake-modal-content" id="modal-content">

        <!-- Draft Resume Prompt -->
        <template if:true={showDraftPrompt}>
            <div class="slds-p-around_medium">
                <div class="draft-prompt">
                    <lightning-icon
                        icon-name="utility:save"
                        size="large"
                        class="slds-m-right_medium">
                    </lightning-icon>
                    <div class="draft-prompt-content">
                        <p class="slds-text-heading_medium slds-m-bottom_x-small">
                            Draft Found
                        </p>
                        <p class="slds-text-body_regular slds-m-bottom_x-small">
                            You have <strong>{draftQuestionText}</strong> saved from <strong>{draftTimestamp}</strong>.
                        </p>
                        <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_medium">
                            Would you like to resume where you left off, or start fresh?
                        </p>
                        <div class="slds-grid slds-gutters_small">
                            <div class="slds-col">
                                <lightning-button
                                    label="Resume Where I Left Off"
                                    variant="brand"
                                    onclick={handleResumeDraft}
                                    class="slds-size_1-of-1">
                                </lightning-button>
                            </div>
                            <div class="slds-col">
                                <lightning-button
                                    label="Start Fresh"
                                    variant="neutral"
                                    onclick={handleStartFresh}
                                    class="slds-size_1-of-1">
                                </lightning-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Loading Spinner -->
        <template if:true={showLoading}>
            <div class="slds-align_absolute-center" style="height: 300px;">
                <lightning-spinner
                    alternative-text="Loading intake questions"
                    size="medium">
                </lightning-spinner>
            </div>
        </template>

        <!-- CPQ Eligible Screen -->
        <template if:true={showCPQScreen}>
            <div class="slds-p-around_medium">
                <div class="cpq-notice">
                    <lightning-icon
                        icon-name="utility:announcement"
                        size="large"
                        variant="warning"
                        class="slds-m-right_medium">
                    </lightning-icon>
                    <div>
                        <p class="slds-text-heading_medium slds-m-bottom_small">
                            This case is eligible for CPQ
                        </p>
                        <p class="slds-text-body_regular">
                            Please use the <strong>"Add Quote"</strong> button at the top of the screen
                            to configure the customer's requested change using the Configure Price Quote tool.
                        </p>
                        <div class="slds-m-top_medium">
                            <lightning-button
                                label="Close"
                                variant="brand"
                                onclick={handleClose}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Main Intake Form -->
        <template if:true={showQuestions}>
            <div class="question-stack">
                <template for:each={state.questionHistory} for:item="question" for:index="index">
                    <c-question-item
                        key={question.questionId}
                        question={question}
                        is-active={question.isActive}
                        index={index}
                        onanswerselected={handleAnswerSelected}
                        oneditquestion={handleEditQuestion}>
                    </c-question-item>
                </template>
            </div>
        </template>

        <!-- Answer Summary Screen -->
        <template if:true={showAnswerSummary}>
            <c-answer-summary
                questions={state.questionHistory}
                final-outcome={state.finalOutcome}
                is-loading={state.isLoading}
                onback={handleBackFromSummary}
                onsubmit={handleFinalSubmit}
                oneditquestion={handleEditQuestion}>
            </c-answer-summary>
        </template>

        <!-- Error State -->
        <template if:true={showError}>
            <div class="slds-p-around_medium">
                <div class="error-message">
                    <lightning-icon
                        icon-name="utility:error"
                        size="small"
                        variant="error"
                        class="slds-m-right_small">
                    </lightning-icon>
                    <div>
                        <p class="slds-text-heading_small slds-text-color_error slds-m-bottom_x-small">
                            Unable to load intake questions
                        </p>
                        <p class="slds-text-body_regular">
                            {state.error}
                        </p>
                        <div class="slds-m-top_medium">
                            <lightning-button
                                label="Close"
                                variant="brand"
                                onclick={handleClose}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

    </div>
</template>
