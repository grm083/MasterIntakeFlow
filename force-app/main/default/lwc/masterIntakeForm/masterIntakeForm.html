<template>
    <div class="intake-container">

        <!-- Loading Spinner -->
        <template if:true={showLoading}>
            <div class="slds-align_absolute-center" style="height: 300px;">
                <lightning-spinner
                    alternative-text="Loading intake questions"
                    size="medium">
                </lightning-spinner>
            </div>
        </template>

        <!-- CPQ Eligible Screen -->
        <template if:true={showCPQScreen}>
            <lightning-card title="Quote Eligible" icon-name="standard:quotes">
                <div class="slds-p-around_medium">
                    <div class="cpq-notice">
                        <lightning-icon
                            icon-name="utility:announcement"
                            size="large"
                            variant="warning"
                            class="slds-m-right_medium">
                        </lightning-icon>
                        <div>
                            <p class="slds-text-heading_medium slds-m-bottom_small">
                                This case is eligible for CPQ
                            </p>
                            <p class="slds-text-body_regular">
                                Please use the <strong>"Add Quote"</strong> button at the top of the screen
                                to configure the customer's requested change using the Configure Price Quote tool.
                            </p>
                        </div>
                    </div>
                </div>
            </lightning-card>
        </template>

        <!-- Main Intake Form -->
        <template if:true={showQuestions}>
            <lightning-card icon-name="custom:custom63">

                <!-- Card Title with Case Context -->
                <div slot="title">
                    <div class="card-header">
                        <div class="slds-text-heading_small">Master Intake Flow</div>
                        <div class="slds-text-body_small slds-text-color_weak slds-m-top_xxx-small">
                            {caseContextDisplay}
                        </div>
                    </div>
                </div>

                <!-- Progress Indicator -->
                <div slot="actions">
                    <div class="progress-indicator">
                        <lightning-icon
                            icon-name="utility:checkin"
                            size="x-small"
                            class="slds-m-right_xx-small">
                        </lightning-icon>
                        <span class="slds-text-body_small">{questionCountDisplay}</span>
                    </div>
                </div>

                <!-- Question Stack -->
                <div class="slds-card__body slds-card__body_inner">
                    <div class="question-stack">
                        <template for:each={state.questionHistory} for:item="question" for:index="index">
                            <c-question-item
                                key={question.questionId}
                                question={question}
                                is-active={question.isActive}
                                index={index}
                                onanswerselected={handleAnswerSelected}
                                oneditquestion={handleEditQuestion}>
                            </c-question-item>
                        </template>
                    </div>
                </div>

            </lightning-card>
        </template>

        <!-- Answer Summary Screen -->
        <template if:true={showAnswerSummary}>
            <c-answer-summary
                questions={state.questionHistory}
                final-outcome={state.finalOutcome}
                is-loading={state.isLoading}
                onback={handleBackFromSummary}
                onsubmit={handleFinalSubmit}
                oneditquestion={handleEditQuestion}>
            </c-answer-summary>
        </template>

        <!-- Error State -->
        <template if:true={showError}>
            <lightning-card>
                <div class="slds-p-around_medium">
                    <div class="error-message">
                        <lightning-icon
                            icon-name="utility:error"
                            size="small"
                            variant="error"
                            class="slds-m-right_small">
                        </lightning-icon>
                        <div>
                            <p class="slds-text-heading_small slds-text-color_error slds-m-bottom_x-small">
                                Unable to load intake questions
                            </p>
                            <p class="slds-text-body_regular">
                                {state.error}
                            </p>
                        </div>
                    </div>
                </div>
            </lightning-card>
        </template>

    </div>
</template>
